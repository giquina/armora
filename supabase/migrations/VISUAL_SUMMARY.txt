
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         ARMORA MARKETPLACE TRANSFORMATION - PHASE 1 MIGRATION            â•‘
â•‘                     Database Schema Migration Complete                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        TABLES MODIFIED                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ğŸ“Š PROTECTION_OFFICERS (13 new columns)
  â”œâ”€â”€ Stripe Connect Integration
  â”‚   â”œâ”€â”€ stripe_connect_id (TEXT, UNIQUE)
  â”‚   â””â”€â”€ stripe_connect_status (TEXT)
  â”‚
  â”œâ”€â”€ Contractor Management
  â”‚   â”œâ”€â”€ contractor_status (TEXT)
  â”‚   â”œâ”€â”€ bank_details_verified (BOOLEAN)
  â”‚   â””â”€â”€ onboarding_completed_at (TIMESTAMP)
  â”‚
  â”œâ”€â”€ Marketplace Pricing
  â”‚   â”œâ”€â”€ daily_rate (DECIMAL, min Â£180)
  â”‚   â”œâ”€â”€ hourly_rate (DECIMAL, min Â£22.50)
  â”‚   â””â”€â”€ minimum_booking_hours (INTEGER)
  â”‚
  â”œâ”€â”€ Network & Equipment
  â”‚   â”œâ”€â”€ substitute_network (JSONB)
  â”‚   â””â”€â”€ equipment (JSONB)
  â”‚
  â”œâ”€â”€ Availability
  â”‚   â””â”€â”€ is_available (BOOLEAN)
  â”‚
  â””â”€â”€ Business Information
      â”œâ”€â”€ company_name (TEXT)
      â”œâ”€â”€ tax_id (TEXT)
      â””â”€â”€ business_address (JSONB)

  ğŸ’° PROTECTION_ASSIGNMENTS (10 new columns)
  â”œâ”€â”€ Payment Split
  â”‚   â”œâ”€â”€ client_total (DECIMAL)
  â”‚   â”œâ”€â”€ platform_fee (DECIMAL)
  â”‚   â”œâ”€â”€ cpo_earnings (DECIMAL)
  â”‚   â””â”€â”€ commission_rate (DECIMAL, default 15%)
  â”‚
  â”œâ”€â”€ Payout Management
  â”‚   â””â”€â”€ payout_status (TEXT)
  â”‚
  â”œâ”€â”€ Enhanced Lifecycle
  â”‚   â”œâ”€â”€ accepted_at (TIMESTAMP)
  â”‚   â”œâ”€â”€ completed_at (TIMESTAMP)
  â”‚   â”œâ”€â”€ cancelled_at (TIMESTAMP)
  â”‚   â””â”€â”€ cancellation_reason (TEXT)
  â”‚
  â”œâ”€â”€ Enhanced Locations
  â”‚   â”œâ”€â”€ pickup_location (JSONB)
  â”‚   â””â”€â”€ dropoff_location (JSONB)
  â”‚
  â””â”€â”€ Assignment Details
      â”œâ”€â”€ assignment_type (TEXT)
      â””â”€â”€ vehicle_type (TEXT)

  ğŸ’³ CPO_PAYOUTS (NEW TABLE - 18 columns)
  â”œâ”€â”€ Relationships
  â”‚   â”œâ”€â”€ id (UUID, PRIMARY KEY)
  â”‚   â”œâ”€â”€ cpo_id (UUID, FK)
  â”‚   â””â”€â”€ assignment_id (UUID, FK, UNIQUE)
  â”‚
  â”œâ”€â”€ Amounts
  â”‚   â”œâ”€â”€ amount (DECIMAL)
  â”‚   â”œâ”€â”€ platform_fee (DECIMAL)
  â”‚   â””â”€â”€ client_total (DECIMAL)
  â”‚
  â”œâ”€â”€ Status & Stripe
  â”‚   â”œâ”€â”€ status (TEXT)
  â”‚   â”œâ”€â”€ stripe_transfer_id (TEXT)
  â”‚   â””â”€â”€ stripe_payout_id (TEXT)
  â”‚
  â”œâ”€â”€ Failure Handling
  â”‚   â”œâ”€â”€ failure_reason (TEXT)
  â”‚   â”œâ”€â”€ failure_code (TEXT)
  â”‚   â””â”€â”€ retry_count (INTEGER)
  â”‚
  â”œâ”€â”€ Timing
  â”‚   â”œâ”€â”€ created_at (TIMESTAMP)
  â”‚   â”œâ”€â”€ processed_at (TIMESTAMP)
  â”‚   â”œâ”€â”€ expected_payout_date (DATE)
  â”‚   â””â”€â”€ actual_payout_date (DATE)
  â”‚
  â””â”€â”€ Metadata
      â”œâ”€â”€ metadata (JSONB)
      â””â”€â”€ admin_notes (TEXT)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     INDEXES CREATED (14 total)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ğŸ” Protection Officers (4 indexes)
  â”œâ”€â”€ idx_protection_officers_stripe_connect_id
  â”œâ”€â”€ idx_protection_officers_contractor_status
  â”œâ”€â”€ idx_protection_officers_availability
  â””â”€â”€ idx_protection_officers_stripe_connect_status

  ğŸ” Protection Assignments (4 indexes)
  â”œâ”€â”€ idx_protection_assignments_payout_status
  â”œâ”€â”€ idx_protection_assignments_accepted_at
  â”œâ”€â”€ idx_protection_assignments_completed_at
  â””â”€â”€ idx_protection_assignments_available

  ğŸ” CPO Payouts (6 indexes)
  â”œâ”€â”€ idx_cpo_payouts_cpo_id
  â”œâ”€â”€ idx_cpo_payouts_assignment_id
  â”œâ”€â”€ idx_cpo_payouts_status
  â”œâ”€â”€ idx_cpo_payouts_created_at
  â”œâ”€â”€ idx_cpo_payouts_expected_date
  â””â”€â”€ idx_cpo_payouts_stripe_transfer

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   SECURITY (RLS POLICIES - 7 total)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ğŸ” CPO Payouts Table
  â”œâ”€â”€ âœ… CPOs can SELECT their own payouts
  â”œâ”€â”€ âœ… Service role has full access (ALL)
  â”œâ”€â”€ âŒ CPOs cannot INSERT payouts
  â”œâ”€â”€ âŒ CPOs cannot UPDATE payouts
  â””â”€â”€ âŒ CPOs cannot DELETE payouts

  ğŸ” Protection Officers Table
  â””â”€â”€ âœ… CPOs can UPDATE their own marketplace profile

  ğŸ” Protection Assignments Table
  â””â”€â”€ âœ… CPOs and Principals can SELECT with payment details

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HELPER FUNCTIONS (2 total)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  âš™ï¸ calculate_payment_split(client_total, commission_rate)
  â””â”€â”€ Calculates: client_total, platform_fee, cpo_earnings
      Example: Â£100 @ 15% â†’ Â£15 fee, Â£85 to CPO

  âš™ï¸ get_cpo_payout_summary(cpo_id)
  â””â”€â”€ Returns: total_earnings, total_paid, total_pending,
              total_assignments, average_earnings

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MIGRATION STATS                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ğŸ“Š File Size: 19KB
  ğŸ“ Total Lines: 484
  ğŸ”§ DDL Statements: 89
  âœ… Safety Clauses: 102 (IF NOT EXISTS / IF EXISTS)
  ğŸ”’ Constraints: 13
  ğŸ”‘ Foreign Keys: 2
  ğŸ“‹ Sections: 8 major sections

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       PAYMENT FLOW EXAMPLE                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Client Books Assignment (Â£200)
         â†“
  Payment Split Calculated
         â”œâ”€â”€ Client Total: Â£200.00
         â”œâ”€â”€ Platform Fee: Â£30.00 (15%)
         â””â”€â”€ CPO Earnings: Â£170.00 (85%)
         â†“
  CPO Accepts Assignment
         â†“
  Assignment Completed
         â†“
  Payout Record Created
         â”œâ”€â”€ Status: pending
         â”œâ”€â”€ Expected Date: +7 days
         â””â”€â”€ Stripe Transfer ID: (awaiting)
         â†“
  Stripe Transfer Processed
         â”œâ”€â”€ Status: completed
         â”œâ”€â”€ Transfer ID: tr_xxxxx
         â””â”€â”€ Payout ID: po_xxxxx
         â†“
  CPO Receives Â£170.00 ğŸ’°

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FILES CREATED                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ğŸ“„ Migration File (19K, 484 lines)
  â””â”€â”€ /workspaces/armora/supabase/migrations/
      â””â”€â”€ 20251002_marketplace_transformation_phase1.sql

  ğŸ“š Documentation (4 files, 45K total)
  â””â”€â”€ /workspaces/armora/supabase/migrations/
      â”œâ”€â”€ README.md (Quick start guide)
      â”œâ”€â”€ MIGRATION_SUMMARY.md (Comprehensive overview)
      â”œâ”€â”€ SCHEMA_REFERENCE.md (Field reference & queries)
      â””â”€â”€ EXECUTION_CHECKLIST.md (Step-by-step checklist)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        EXECUTION STATUS                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  âœ… Migration file created and verified
  âœ… All documentation generated
  âœ… Idempotent and safe to run
  âœ… Includes rollback script
  âœ… All constraints validated
  â³ Ready for execution

  âš ï¸  NOT YET EXECUTED - Awaiting approval

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          NEXT STEPS                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  1ï¸âƒ£  Review migration file and documentation
  2ï¸âƒ£  Backup current database
  3ï¸âƒ£  Execute migration in Supabase
  4ï¸âƒ£  Verify all changes applied
  5ï¸âƒ£  Test helper functions
  6ï¸âƒ£  Begin Phase 2: Service Layer Implementation

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      QUICK EXECUTION                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Option 1: Supabase Dashboard
  â€¢ Go to https://app.supabase.com
  â€¢ Select project â†’ SQL Editor
  â€¢ Copy & paste migration file
  â€¢ Click "Run"

  Option 2: Supabase CLI
  $ supabase link --project-ref your-ref
  $ supabase db push

  Option 3: psql
  $ psql "postgresql://..." -f 20251002_marketplace_transformation_phase1.sql

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                          MIGRATION READY âœ…                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

